@page "/CustomersOriginal"
@using Pixata.Extensions
@using Square
@using Square.Exceptions
@using Square.Models

<PageTitle>Square customers</PageTitle>

<h1>Square customers</h1>

<button @onclick="@ListCustomers">Customers</button>

<div class="text-danger">@CustomersMsg</div>

@if (CustomerList.Any()) {
  <ul>
    @foreach (Customer c in CustomerList) {
      <li>@c.GivenName @c.FamilyName</li>
    }
  </ul>
}

@code{

  private readonly string _accessToken = System.Environment.GetEnvironmentVariable("SquareAccessToken") ?? "";

  public List<Customer> CustomerList { get; set; } = new();
  public string CustomersMsg { get; set; } = "";

  private async Task ListCustomers() {
    CustomersMsg = "Loading customers";
    SquareClient squareClient = GetSquareClient();
    try {
      CustomerList = ((await squareClient.CustomersApi.ListCustomersAsync()).Customers ?? new List<Customer>()).ToList();
      CustomersMsg = CustomerList.Any() ? "" : "No customers";
    }
    catch (ApiException ex) {
      CustomersMsg = $"{ex.GetType().Name}: {ex.Errors.Select(e => $"({e.Category}) {e.Detail}").JoinStr()}";
    }
    catch (Exception ex) {
      CustomersMsg = $"{ex.GetType().Name}: {ex.Message}";
    }
  }

  private SquareClient GetSquareClient() => new SquareClient.Builder()
    .Environment(Square.Environment.Sandbox)
    .AccessToken(_accessToken)
    .Build();

}